/*! datapump 3.47.0 */
import{initializeLogger as t}from"@seamless/logger";import{AUTHENTICATION_CONNECTION as e,isLoggedIn as i,getJwe as n}from"@b2x/authentication-library";import{getDispatchers as o}from"@seamless/one-context";function s(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}c((n=n.apply(t,e||[])).next())}))}const r="@dh-io/datapump",a="OWC_AEM_ENV",c=new class extends window.top.seamlessStore.SeamlessConnection{constructor(){super(a)}get initialState(){const t=window.aemNamespace?.environmentVariables||window.top?.aemNamespace?.environmentVariables,e=window.aemNamespace?.pageEnvironmentVariables||window.top?.aemNamespace?.pageEnvironmentVariables;return t&&e?{...t,...e}:{}}getReducer(){return()=>this.initialState}getPublicDispatchers(){return{}}},d={Authentication:null,Locale:null,Environment:null,DealerContext:null,ConsentList:[],User:null},l="OWC_WKO",u="UPDATE_WKO",h=new class extends window.top.seamlessStore.SeamlessConnection{constructor(){super(l)}get initialState(){return d}getReducer(){return(t=d,e)=>e.type===this.getActionType(u)?{...t,[e.payload.name]:e.payload.value}:t}getPublicDispatchers(){return{setWko:t=>this.getAction(u,t)}}},v=async()=>{const t=window.top.seamlessStore.initializeStore();return await t.getConnectionDispatchers(l)},f="ow_aem",w={authentication:{jwe:`${f}_jwe`,jwt:`${f}_jwt`,token:`${f}_sub`,roles:`${f}_roles`},user:{personal:{name:`${f}_name`,firstname:`${f}_firstname`,lastname:`${f}_lastname`,gender:`${f}_gender`,email:`${f}_email`,phone:`${f}_phone`,roles:`${f}_roles`,wkoUserData:`${f}_wkoUserData`},associatedVehicles:`${f}_userAssociatedVehicles`,associatedDealers:`${f}_userAssociatedDealers`,selectedAssociatedVehicle:`${f}_selectedAssociatedVehicle`,consent:{dataUsageScopes:`${f}_dataUsageScopes`,enableDataUsages:`${f}_enableDataUsages`}}};
/*! connection-aem-environment 2.4.0 */var y,g;(g=y||(y={})).local="local",g.session="session";class BrowserStorageUtils{t;loggingEnabled=!1;logger=t("OWC FE LIBS");constructor(t){window.top.seamlessStore.initializeStore().subscribe(a,(t=>{"prod"!==t.stageVariant&&(this.loggingEnabled=!0)})),this.t=t}get storage(){return this.t===y.local?window.localStorage:window.sessionStorage}async getItem(t){const e=this.storage.getItem(t);if(this.loggingEnabled&&this.logger.log(`${this.t} : getItem : key: ${t}`),null==e)return this.loggingEnabled&&this.logger.warn(`${this.storage} : could not find key: ${t}`),null;try{return JSON.parse(e)}catch{return this.loggingEnabled&&this.logger.warn(`${this.storage} : could not convert "${t}" to JSON, returning it as is`),e}}}const m="Authentication",p="Locale",S="Environment",A="User",E="ConsentList";var k,b,M,O,_,L,D;!function(t){t.SALES="SALES",t.SERVICE="SERVICE"}(k||(k={}));class LoginChecks{sessionStorage=new BrowserStorageUtils("session");wkoManagerDispatchers;user={};authentication={};constructor(){this.init()}async init(){this.wkoManagerDispatchers=await v(),this.initializeLoginchecks()}async getStoredValues(t){const e=Object.keys(t),i=Object.values(t),n=e.reduce((async(t,e,n)=>{const o=await t,s=await this.sessionStorage.getItem(i[n]);return null==s?o:{...o,[e]:s}}),Promise.resolve({}));return await n}async getAuthentication(){return await this.getStoredValues(w.authentication)}async getUserPersonalData(){return await this.getStoredValues(w.user.personal)}async getUserConsent(){return await this.getStoredValues(w.user.consent)}async getSelectedAssociatedVehicle(){return await this.sessionStorage.getItem(w.user.selectedAssociatedVehicle)}async getUserAssociatedVehicles(){return await this.sessionStorage.getItem(w.user.associatedVehicles)}async getUserAssociatedDealers(){return await this.sessionStorage.getItem(w.user.associatedDealers)}getUserSelectedAssociatedDealer(t){const e=t.selectedAssociatedVehicle?.finOrVin;if(t.selectedAssociatedVehicle&&t.userAssociatedDealers&&e){const i=t.userAssociatedDealers[e];if(i)return i.reduce(((t,e)=>(e.dealerType===k.SALES?t.salesDealer=e:e.dealerType===k.SERVICE&&(t.serviceDealer=e),t)),{})}return{}}async getLoginchecksObject(){const t=await Promise.all([this.getAuthentication(),this.getUserPersonalData(),this.getUserAssociatedVehicles(),this.getSelectedAssociatedVehicle(),this.getUserAssociatedDealers(),this.getUserConsent()]);return{authentication:t[0],userPersonalData:t[1],associatedVehicles:t[2],selectedAssociatedVehicle:t[3],userAssociatedDealers:t[4],userConsent:t[5]}}updateStore(t,e){this.wkoManagerDispatchers.setWko({name:t,value:e})}async generateLoginchecksWkos(){const t=await this.getLoginchecksObject(),e=this.getUserSelectedAssociatedDealer(t);this.user={personal:t.userPersonalData,associatedVehicles:t.associatedVehicles,selectedAssociatedVehicle:t.selectedAssociatedVehicle,selectedAssociatedDealer:e,associatedDealers:t.userAssociatedDealers,consent:t.userConsent},this.authentication=t.authentication}async initializeLoginchecks(){this.generateLoginchecksWkos().then((()=>{this.updateStore(m,this.authentication),this.updateStore(A,this.user),this.addWkoManagerListener()}))}addWkoManagerListener(){window.addEventListener("wko-manager-update",(async()=>{await this.generateLoginchecksWkos(),this.updateStore(A,this.user)}))}}!function(t){t.ucEvents="ucEvents",t.ucEventsUpdated="usercentrics-consents-updated",t.ucConsentsLoaded="usercentrics-consents-loaded"}(b||(b={}));class ConsentList{wkoManagerConnection;constructor(){this.init(),this.addEventListeners()}async init(){this.wkoManagerConnection=await v()}addEventListeners(){window.addEventListener(b.ucEventsUpdated,this.consentListener),document.addEventListener(b.ucConsentsLoaded,this.consentListener,!1)}consentListener=t=>{t.detail&&t.detail.consents&&this.wkoManagerConnection.setWko({name:E,value:t.detail.consents})}}class WKOManager{store=window.top.seamlessStore.initializeStore();allWkos;loginChecks;consentList;constructor(){this.initializeWkoManager()}async initializeWkoManager(){const t=await v();this.store.subscribe(a,(e=>{t.setWko({name:S,value:e}),t.setWko({name:p,value:{country:e.country,language:e.language}})})),this.store.subscribe(l,(t=>{this.allWkos=t})),this.loginChecks=new LoginChecks,this.consentList=new ConsentList}}!function(t){t.LOCAL="LOCAL",t.TEST="TEST",t.DEV="DEV",t.INT="INT",t.PPROD="PPROD",t.PROD="PROD"}(M||(M={})),function(t){t.AFFINITY_SCORE="AFFINITY_SCORE",t.LIVE_MARKETS="LIVE_MARKETS"}(O||(O={})),function(t){t.MMVVS="MMV-VS",t.TOUCHPOINTS="MM-CONSID_TOUCHPOINTS",t.TSS_WISHLIST="TSS_WISHLIST-SAVED-PRODUCTS",t.MM_CONSID_VEHICLES="MM-CONSID_VEHICLES",t.B2XCORE_AUTHENTICATION="B2XCORE_AUTHENTICATION",t.B2XCORE_LOGIN="B2XCORE_USER_LOGIN",t.LIVE_MARKETS="LIVE_MARKETS"}(_||(_={}));class LocalAemSetup{static initializeAEMIfNeeded(){return s(this,void 0,void 0,(function*(){const e=t(r),i=window.top.seamlessStore.initializeStore();try{yield i.getConnection(a,1e3)}catch(t){e.log("----\x3e AEM environment missing from Seamless Store, adding the connection."),yield(async()=>{const t=window.top.seamlessStore.initializeStore();return await(async()=>{if(!window.top?.aemNamespace&&!window.aemNamespace)return new Promise((t=>{let e;Object.defineProperty(window.top,"aemNamespace",{get:()=>e,async set(i){e=i,t()}})}))})(),await(async()=>{if(!window.top?.aemNamespace?.environmentVariables&&!window?.aemNamespace?.environmentVariables)return new Promise((t=>{let e;Object.defineProperty(window.top?.aemNamespace,"environmentVariables",{get:()=>e,set(i){e=i,t()}})}))})(),await(async()=>{if(!window.top?.aemNamespace?.pageEnvironmentVariables&&!window?.aemNamespace?.pageEnvironmentVariables)return new Promise((t=>{let e;Object.defineProperty(window.top?.aemNamespace,"pageEnvironmentVariables",{get:()=>e,set(i){e=i,t()}})}))})(),t.addConnection(c)
/*! connection-wko-manager 2.4.0 */})()}try{yield i.getConnection(l,1e3)}catch(t){e.log("----\x3e WKOs missing from Seamless Store, adding the connection."),yield(async()=>window.top.seamlessStore.initializeStore().addConnection(h))(),function(){const t=window.top||window;let e=t.owc?.wkoManager;if(null==e&&t.aemNamespace){const i=new WKOManager;t.owc?t.owc.wkoManager=i:t.owc={wkoManager:i},e=t.owc.wkoManager}}()}}))}}!function(t){t.POST_AFFINITY="/affinity/score",t.POST_ONEDOC="/consent/onedoc",t.GET_LIVE_AFFINITY="/status/markets"}(L||(L={}));class DataLayerFetcher{static getDataLayerByEvent(t){const e=this.dataLayer?this.dataLayer.filter((e=>e.event===t)):[],i=e[(null==e?void 0:e.length)-1];return i||{}}static setAffinity(t){const e=this.getDataLayerByEvent("pageview");this.dataLayer&&(e.page.affinity=t,this.dataLayer.push(this.getDataLayerByEvent("pageview")))}}DataLayerFetcher.dataLayer=window.dataLayer_ow,DataLayerFetcher.logger=t(r);class WkoFetcher{static isUserConsentAccepted(){var t,e,i;return s(this,void 0,void 0,(function*(){try{if(yield this.isNonProd())return!0;const n=t=>t&&t.User&&t.User.consent&&null!=t.User.consent.enableDataUsages;return yield this.fetchWellKnownObjectsIfNeeded(n),!0===(null===(i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.User)||void 0===e?void 0:e.consent)||void 0===i?void 0:i.enableDataUsages)}catch(t){return!1}}))}static checkDataUsageScopes(t){return!!(t&&t.length>0)&&t.every((t=>t.agreed))}static isOneDocAccepted(){return s(this,void 0,void 0,(function*(){try{const t=yield this.getFirstName(),e=yield this.getLastName(),i=yield this.getEmailAdress(),n=yield this.getMpc();if(!(t&&e&&i&&n))return!1;const o={country:n,firstname:t,lastname:e,email:i};return(yield C.request(L.POST_ONEDOC,D.POST,o)).onlinetracksm}catch(t){return!1}}))}static isNonProd(){return s(this,void 0,void 0,(function*(){return(yield this.getStage())!==M.PROD}))}static checkIsLoggedIn(){return s(this,void 0,void 0,(function*(){return!!(yield WkoFetcher.getJweBearer(5e3))}))}static getJweBearer(t=0){var e,i;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.Authentication&&t.Authentication.jwe),t);const n=null===(i=null===(e=this.wellKnowObjects)||void 0===e?void 0:e.Authentication)||void 0===i?void 0:i.jwe;if(!n)return;switch(yield this.getStage()){case M.LOCAL:case M.TEST:case M.DEV:return this.logger.log("Using Test JWE"),this.TESTJWE}return`Bearer ${n}`}))}static getMpc(){var t,e;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.Locale&&t.Locale.country));const i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.Locale)||void 0===e?void 0:e.country;return i||(this.logger.log("No country available"),"")}))}static getLanguage(){var t,e;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.Locale&&t.Locale.language));const i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.Locale)||void 0===e?void 0:e.language;return i||(this.logger.log("No language available"),"")}))}static getStage(){var t,e,i,n;return s(this,void 0,void 0,(function*(){const o=null===(e=null===(t=DataLayerFetcher.getDataLayerByEvent("global"))||void 0===t?void 0:t.site)||void 0===e?void 0:e.sysEnv;if(!o){const t=t=>t&&t.Environment&&t.Environment.stage;yield this.fetchWellKnownObjectsIfNeeded(t)}const s=(null===(n=null===(i=this.wellKnowObjects)||void 0===i?void 0:i.Environment)||void 0===n?void 0:n.stage)||o;if(!s)throw new Error("Failed to get the stage.");return s}))}static getFirstName(){var t,e,i;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.User&&t.User.personal&&t.User.personal&&t.User.personal.fistname),1e3);let n=null===(i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.User)||void 0===e?void 0:e.personal)||void 0===i?void 0:i.name;return n?(n=null==n?void 0:n.split(" ")[0],n):(this.logger.log("No firstname available"),null)}))}static getLastName(){var t,e,i;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.User&&t.User.personal&&t.User.personal&&t.User.personal.lastname),1e3);const n=null===(i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.User)||void 0===e?void 0:e.personal)||void 0===i?void 0:i.lastname;return n||(this.logger.log("No lastname available"),null)}))}static getEmailAdress(){var t,e,i;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.User&&t.User.personal&&t.User.personal&&t.User.personal.email),1e3);const n=null===(i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.User)||void 0===e?void 0:e.personal)||void 0===i?void 0:i.email;return n||(this.logger.log("No email available"),null)}))}static getZipCode(){var t,e,i,n;return s(this,void 0,void 0,(function*(){yield this.fetchWellKnownObjectsIfNeeded((t=>t&&t.User&&t.User.personal&&t.User.personal.wkoUserData&&t.User.personal.wkoUserData.zipCode),1e3);const o=null===(n=null===(i=null===(e=null===(t=this.wellKnowObjects)||void 0===t?void 0:t.User)||void 0===e?void 0:e.personal)||void 0===i?void 0:i.wkoUserData)||void 0===n?void 0:n.zipCode;return o||(this.logger.log("No zipCode available"),null)}))}static getConsenList(t=0){var e;return s(this,void 0,void 0,(function*(){0!==t&&(yield new Promise((e=>setTimeout(e,t))));yield this.fetchWellKnownObjectsIfNeeded((t=>{var e;return t&&(null===(e=null==t?void 0:t.ConsentList)||void 0===e?void 0:e.length)>0?null==t?void 0:t.ConsentList:[]}),1e3);const i=null===(e=this.wellKnowObjects)||void 0===e?void 0:e.ConsentList;return i||(this.logger.log("No consentList available"),[])}))}static fetchWellKnownObjectsIfNeeded(t,e=0){return s(this,void 0,void 0,(function*(){if(yield LocalAemSetup.initializeAEMIfNeeded(),!t(this.wellKnowObjects))return new Promise((i=>{0!==e&&setTimeout(i,e),this.store.subscribe(l,(e=>{this.wellKnowObjects=e,t(e)&&i()}))}))}))}}WkoFetcher.TESTJWE="00110207a62c4365",WkoFetcher.store=window.top.seamlessStore.initializeStore(),WkoFetcher.logger=t(r);class B2xFetcher{static onAuthenticationEvent(){return s(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{var o;setTimeout(n,3e3),null===(o=this.store)||void 0===o||o.subscribe(e,(e=>{var o,s;if(e)this.isLoggedIn=i(e),t();else{const e=null===(s=null===(o=DataLayerFetcher.getDataLayerByEvent("global"))||void 0===o?void 0:o.user)||void 0===s?void 0:s.loginState;this.isLoggedIn=e&&!e.includes("out"),this.isLoggedIn?t():n(new Error("Authentication failed"))}}))}))}))}static isUserLoggedIn(){return s(this,void 0,void 0,(function*(){return yield this.onAuthenticationEvent(),this.isLoggedIn}))}static onJweEvent(){return s(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{var o;null===(o=this.store)||void 0===o||o.subscribe(e,(e=>{e?(this.jweValue=n(e)||"",t()):i(new Error("JWE token failed"))}))}))}))}static getJwe(){return s(this,void 0,void 0,(function*(){yield this.onJweEvent();switch(yield WkoFetcher.getStage()){case M.LOCAL:case M.TEST:case M.DEV:return this.logger.log("Using Test JWE"),this.TESTJWE}return`Bearer ${this.jweValue}`}))}}B2xFetcher.TESTJWE="00110207a62c4365",B2xFetcher.store=window.top.seamlessStore.initializeStore(),B2xFetcher.logger=t(r),function(t){t.GET="GET",t.POST="POST",t.PUT="PUT",t.DELETE="DELETE"}(D||(D={}));class APIService{static request(t,e,i,n){return s(this,void 0,void 0,(function*(){const o=yield WkoFetcher.getStage(),r=this.buildFullUrl(t,o),a=yield this.getHeaders(o,n),c=i?JSON.stringify(i):void 0,d={headers:a,method:e,body:c};return fetch(r.toString(),d).then((t=>s(this,void 0,void 0,(function*(){try{if(200===t.status){return yield t.json()}return this.logger.log(t.status),{}}catch(t){return this.logger.error(t),{}}}))))}))}static buildFullUrl(t,e){const i=this.getApiBaseUrl(e);return new URL(`${i}${t}`)}static getHeaders(t,e){return s(this,void 0,void 0,(function*(){let t=e;return t=e&&0!==e.length?e:yield B2xFetcher.getJwe(),Promise.resolve({Authorization:t,"Content-Type":"application/json"})}))}static getApiBaseUrl(t){const e="/api/v0";switch(t){case M.LOCAL:case M.DEV:return"https://dev.api.oneweb.mercedes-benz.com/mbscore"+e;case M.TEST:return"https://test.api.oneweb.mercedes-benz.com/mbscore"+e;case M.INT:case M.PPROD:return"https://int.api.oneweb.mercedes-benz.com/mbscore"+e;case M.PROD:return"https://api.oneweb.mercedes-benz.com/mbscore"+e;default:throw new Error("Failed to get the stage environment.")}}}APIService.logger=t(r);var F,C=APIService;!function(t){t.SET_AFFINITY_SCORE="AFFINITY_SCORE/SET_AFFINITY_SCORE",t.LOAD_PERSISTED_STATE="AFFINITY_SCORE/LOAD_PERSISTED_STATE"}(F||(F={}));const P=t=>({type:F.LOAD_PERSISTED_STATE,state:t}),T=t=>({type:F.SET_AFFINITY_SCORE,state:t}),I=t=>e=>s(void 0,void 0,void 0,(function*(){e(T({affinityScore:t}))}));class AffinityScoreConnection extends window.top.seamlessStore.PersistentConnection{constructor(){super(O.AFFINITY_SCORE)}get initialState(){return $}get storageType(){return"session"}getReducer(){return N}getPublicDispatchers(){return{setAffinityScore:T,saveAffinityScoreToStore:I,loadPersistedState:P}}loadPersistedStateCallback(t){return s(this,void 0,void 0,(function*(){return P(t)}))}transformToPersistentState(t){return Object.assign(Object.assign({},t),{fromPersistFunction:!0})}}const $={affinityScore:void 0},N=(t,e)=>{switch(e.type){case F.LOAD_PERSISTED_STATE:return e.state?((t,e)=>void 0===e?t:e)(t,e.state):t;case F.SET_AFFINITY_SCORE:return Object.assign(Object.assign({},t),e.state);default:return t}};let U;const V=new Uint8Array(16);function W(){if(!U&&(U="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!U))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return U(V)}const B=[];for(let t=0;t<256;++t)B.push((t+256).toString(16).slice(1));var R,j={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function x(t,e,i){if(j.randomUUID&&!e&&!t)return j.randomUUID();const n=(t=t||{}).random||(t.rng||W)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){i=i||0;for(let t=0;t<16;++t)e[i+t]=n[t];return e}return function(t,e=0){return(B[t[e+0]]+B[t[e+1]]+B[t[e+2]]+B[t[e+3]]+"-"+B[t[e+4]]+B[t[e+5]]+"-"+B[t[e+6]]+B[t[e+7]]+"-"+B[t[e+8]]+B[t[e+9]]+"-"+B[t[e+10]]+B[t[e+11]]+B[t[e+12]]+B[t[e+13]]+B[t[e+14]]+B[t[e+15]]).toLowerCase()}(n)}!function(t){t.SET_LIVE_MARKETS="LIVE_MARKETS/SET_LIVE_MARKETS"}(R||(R={}));const J=t=>({type:R.SET_LIVE_MARKETS,state:t});class MarketConnection extends window.top.seamlessStore.SeamlessConnection{constructor(){super(O.LIVE_MARKETS)}get initialState(){return z}getReducer(){return K}getPublicDispatchers(){return{setMarket:J}}}const z={liveMarkets:void 0},K=(t,e)=>e.type===R.SET_LIVE_MARKETS?Object.assign(Object.assign({},t),e.state):t;class MarketFetcher{static fetchLiveMarkets(){return s(this,void 0,void 0,(function*(){return new Promise((t=>{this.store.subscribe(this.connectionName,(e=>{this.liveMarkets=e,t()}))}))}))}static getLiveMarkets(){var t,e;return s(this,void 0,void 0,(function*(){if(yield this.fetchLiveMarkets(),this.liveMarkets&&(null===(t=this.liveMarkets)||void 0===t?void 0:t.liveMarkets))return null===(e=this.liveMarkets)||void 0===e?void 0:e.liveMarkets;Promise.resolve(null)}))}}var H;MarketFetcher.store=window.top.seamlessStore.initializeStore(),MarketFetcher.logger=t(r),MarketFetcher.connectionName=O.LIVE_MARKETS,MarketFetcher.liveMarkets={liveMarkets:{}};class AffinityManager{static setAffinityScoreDispatcher(){return s(this,void 0,void 0,(function*(){var t;yield s(void 0,void 0,void 0,(function*(){t||(t=window.top.seamlessStore.initializeStore()),t.addConnection(new AffinityScoreConnection)})),H.affinityScoreDispatcher=yield H.store.getConnectionDispatchers(O.AFFINITY_SCORE)}))}static setMarketDispatcher(){return s(this,void 0,void 0,(function*(){var t;yield s(void 0,void 0,void 0,(function*(){t||(t=window.top.seamlessStore.initializeStore()),t.addConnection(new MarketConnection)})),H.marketDispatcher=yield H.store.getConnectionDispatchers(O.LIVE_MARKETS)}))}static setAffinityScoreOnOneContext(t){return s(this,void 0,void 0,(function*(){(yield o("cuan","MBScoreConnection")).updateAffinityScore(t)}))}static getCookieValue(){try{const t=this.getCookieValueFromDokument();if(t)return t;const e=this.createCookie();return e||void 0}catch(t){return void H.logger.log("Error while getting cookie value:",t)}}static getCookieValueFromDokument(){return H.cookieMatch||(H.cookieMatch=`; ${document.cookie}`.match(`;\\s*${H.cookieName}=([^;]+)`)),H.cookieMatch?H.cookieMatch[1]:void 0}static createCookie(){try{const t=new Date;t.setFullYear(t.getFullYear()+1);const e=t.toUTCString(),i=x();this.cookieName;return H.setValueByPath(document,this.cookieName,i,{path:"/",domain:window.location.hostname,expires:e}),i}catch(t){return void this.logger.error(t)}}static setValueByPath(t,e,i,n){const o=e.split(".");let s=t;for(let t=0;t<o.length-1;t++){const e=o[t];"__proto__"!==e&&"constructor"!==e&&"prototype"!==e&&("object"!=typeof s[e]&&(s[e]={}),s=s[e])}document.cookie=`${o.join(".")}=${i}; path=${n.path||"/"}; domain=${n.domain||window.location.hostname}; expires=${n.expires||""}`}static getConsentListOfWko(){return s(this,void 0,void 0,(function*(){return yield WkoFetcher.getConsenList(2e3)}))}static isCookieEnabled(t){return s(this,void 0,void 0,(function*(){const e=JSON.parse(window.sessionStorage.ow_aem_consentList);let i=e;0===(null==e?void 0:e.length)&&(i=yield this.getConsentListOfWko());const n=i.find((e=>e.name===t));return!!n&&(null==n?void 0:n.enabled)}))}static hasBm(t){return t.baumuster&&null!==t.baumuster.length}static isDuplicatePageViewEvent(t){return JSON.stringify(H.scoredPageviewRequest)===JSON.stringify(t)}static getLiveAffinityMarkets(){return s(this,void 0,void 0,(function*(){return(yield C.request(L.GET_LIVE_AFFINITY,D.GET))||{}}))}static handleAffinityPayload(t){const e={pageName:"",pageType:"",baumuster:"",market:"",language:"",visited_url:""};if("event"in t&&"page"in t){const i=t;if("products"in i.page){const t=i,n=t.page.products;if(1===n.length){const t=n[0];e.baumuster=t.variantId}e.pageName=t.page.name,e.pageType=t.page.type}else if("cart"in i.page&&1===i.page.cart.products.length){const t=i,n=t.page.cart.products[0];e.pageName=t.page.name,e.pageType=t.page.type,e.baumuster=n.variantId}else{const t=i;if(e.pageName=t.page.name,e.pageType=t.page.type,"vehicle"in i.page){const t=i.page.vehicle;e.baumuster=(null==t?void 0:t.baumusterId)||(null==t?void 0:t.modelCode)||""}}}return e}}H=AffinityManager,AffinityManager.logger=t(r),AffinityManager.store=window.top.seamlessStore.initializeStore(),AffinityManager.cookieName="mb_score",AffinityManager.sessionName=["Mercedes-Benz_Product_Affinity_Score","Mercedes-Benz_Data-Sharing"],AffinityManager.liveMarketsInStorage=sessionStorage.getItem("liveMarkets"),AffinityManager.cookieMatch=null,AffinityManager.calcAffinityScore=(t,e)=>s(void 0,void 0,void 0,(function*(){var t,i,n,o,s,r,a;yield H.setMarketDispatcher();try{const[c,d,l,u,h,v]=yield Promise.allSettled([WkoFetcher.getMpc(),WkoFetcher.getLanguage(),B2xFetcher.isUserLoggedIn(),MarketFetcher.getLiveMarkets(),H.isCookieEnabled(H.sessionName[0]),H.isCookieEnabled(H.sessionName[1])]);if("fulfilled"===c.status&&"fulfilled"===d.status&&"fulfilled"===l.status&&"fulfilled"===u.status&&"fulfilled"===h.status&&"fulfilled"===v.status){if(h.value&&v.value&&!l.value){const l=e||(u.value&&(null===(i=null===(t=u.value)||void 0===t?void 0:t.affinityScore)||void 0===i?void 0:i.length)>0?u.value:yield H.getLiveAffinityMarkets());if(null===(n=null==l?void 0:l.affinityScore)||void 0===n?void 0:n.find((t=>t===c.value))){const t=DataLayerFetcher.getDataLayerByEvent("pageview"),i=H.handleAffinityPayload(t);if(i.market=c.value,i.language=d.value,i.visited_url=window.location.href,!H.isDuplicatePageViewEvent(i)||Y()){H.scoredPageviewRequest=i;let t="";t="Bearer "+H.getCookieValue(),H.logger.log("calling POST_AFFINITY");const n=yield C.request(L.POST_AFFINITY,D.POST,i,t);u.value&&(null===(s=null===(o=u.value)||void 0===o?void 0:o.affinityScore)||void 0===s?void 0:s.length)>0||(H.marketDispatcher||(yield H.setMarketDispatcher()),null===(r=H.marketDispatcher)||void 0===r||r.setMarket({liveMarkets:null!=l?l:e})),H.affinityScoreDispatcher||(yield H.setAffinityScoreDispatcher()),null===(a=H.affinityScoreDispatcher)||void 0===a||a.saveAffinityScoreToStore(n),H.setAffinityScoreOnOneContext(n)}}}}else H.logger.log("one or more promise were rejected")}catch(t){H.logger.log("An Error Occured:",t)}}));const Y=()=>!!document.querySelector("owc-stage");t(r);const G=t=>s(void 0,void 0,void 0,(function*(){(yield B2xFetcher.isUserLoggedIn())||(yield AffinityManager.calcAffinityScore(t))})),X=t(r);function q(t){return s(this,void 0,void 0,(function*(){yield G(t)}))}AffinityManager.setAffinityScoreDispatcher();let Z="";new MutationObserver((function(t){location.href!==Z&&(Z=location.href,X.log(`URL change to ${location.href}`),q())})).observe(document,{subtree:!0,childList:!0}),window.datapump={calculateAffinityScore:q};export{q as calculateAffinityScore};
//# sourceMappingURL=index.js.map
